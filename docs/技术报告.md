# AIChat-Server 技术报告

## 概述
AIChat-Server 是基于 Spring Boot 的后端服务，提供账号密码认证、会话与消息管理、SSE 流式输出以及模型列表查询等能力。当前版本已从短信验证码登录切换为账号密码体系，并统一错误返回结构以便前端对接。

## 技术栈与模块
- 平台：Spring Boot 4，Java 21
- Web：spring-boot-starter-web / webflux（SSE）
- 数据访问：spring-boot-starter-data-jpa，MySQL
- 安全：JJWT（HS256），BCrypt 密码哈希
- 监控：spring-boot-starter-actuator（可选）

核心包结构：
- `controller`：`AuthController`、`HealthController`、`ConversationController`、`MessageController`、`StreamController`、`ModelsController`、`MultimodalController`
- `config`：`WebConfig`（鉴权与并发拦截）、`GlobalExceptionHandler`（统一错误）、`AiConfig`（AI相关配置）、`SmsConfig`（历史保留）
- `domain` / `repo`：实体与仓库，如 `User`、`Message`、`UserRepository`
- `service`：`JwtService`、`PasswordService`、`AiService` 等

## 数据模型
- `users` 表：`id`（Long），`username`（唯一），`password_hash`，`created_at`
- JPA 迁移：`spring.jpa.hibernate.ddl-auto=update`，首次运行自动建表

## 配置与环境变量
位于 `src/main/resources/application.yaml`：
- 端口：`server.port: 8080`
- 数据源：`spring.datasource.url`（默认 `jdbc:mysql://127.0.0.1:3306/aichat...`）、`username`、`password`
- JWT：`security.jwt.secret=${APP_JWT_SECRET}`，`security.jwt.expiresSeconds=${APP_TOKEN_TTL_SEC}`（默认 86400s）
- CORS 示例：`cors.allowed-origins`（默认允许 `http://localhost:3000,http://127.0.0.1:3000`）

## 认证与访问控制
- 认证方式：账号密码注册/登录，返回 JWT
- 鉴权规则：非 `/auth/*` 与 `/health` 的接口必须携带 `Authorization: Bearer <token>`
- 错误统一：`{"code","message"}`，示例：
  - `VALIDATION_ERROR`（如 `username_required`、`password_too_short`）
  - `UNAUTHORIZED`（如 `invalid_credentials`、`invalid_token`）
  - `CONFLICT`（如 `username_exists`）
  - `RATE_LIMIT`（可扩展到登录/注册限流）

## 接口一览
- 健康：`GET /health` → `{status: "OK"}`
- 注册：`POST /auth/register` Body `{username,password}` → `{token,ttlSec,expiresAt}`
- 登录：`POST /auth/login` Body `{username,password}` → `{token,ttlSec,expiresAt}`
- 旧短信：`POST /auth/sendCode`、`/auth/verify` → `404 deprecated`
- 会话/消息：`/conversations`、`/messages`（需 `Bearer` 令牌）
- SSE 流：`/stream`（需 `Bearer` 令牌；并发拦截在 `WebConfig`）
- 模型列表：`GET /models`（简化返回）

## 构建与运行
```bash
# Windows
./mvnw.cmd -DskipTests package
java -jar aichat-server/aichat-server/target/aichat-server-0.0.1-SNAPSHOT.jar
```
必填环境变量：`APP_JWT_SECRET`；可选：`APP_TOKEN_TTL_SEC`、`DB_URL`、`DB_USER`、`DB_PASS`、`CORS_ALLOWED_ORIGINS`。

## 对接要点（前端）
- 地址规范：
  - 本机浏览器：`http://127.0.0.1:8080`
  - Android 模拟器：`http://10.0.2.2:8080`
  - Genymotion：`http://10.0.3.2:8080`
  - 真机同一 Wi‑Fi：`http://<电脑IPv4>:8080`
- 健康测试：`GET /health`
- 注册/登录：`POST /auth/register|login`，成功后本地持久化 `token` 与过期时间
- 非 `/auth/*` 请求需自动加 `Authorization: Bearer <token>`

## 变更记录
- 切换登录方式：从短信验证码登录改为账号密码注册/登录
- 返回结构统一化：所有错误按 `code/message` 返回
- 新增健康端点：`/health`
- JWT 与 TTL：支持秒级 TTL 与过期时间并返回给前端

