# AIChat-Server 使用说明

## 环境准备
- 操作系统：Windows 或其他
- 运行时：Java 21+
- 构建工具：Maven（内置 `mvnw.cmd` 可直接使用）
- 数据库：MySQL 8（或兼容版本）

## 配置项
编辑或通过环境变量覆盖 `src/main/resources/application.yaml`：
- 端口：`server.port=8080`
- 数据源：
  - `DB_URL`（默认 `jdbc:mysql://127.0.0.1:3306/aichat?...`）
  - `DB_USER`、`DB_PASS`
- JWT：
  - `APP_JWT_SECRET`（必填，建议长度≥32）
  - `APP_TOKEN_TTL_SEC`（默认 `86400`）
- CORS：`CORS_ALLOWED_ORIGINS`（如 `http://localhost:3000`）

## 启动服务
```bash
# 构建
./mvnw.cmd -DskipTests package
# 运行
java -jar aichat-server/aichat-server/target/aichat-server-0.0.1-SNAPSHOT.jar
```

## 健康检查
- `GET /health` → `{"status":"OK"}`
- 若无法访问：
  - 检查端口是否 `8080`
  - 关闭或放行防火墙 8080 入站
  - 确认地址写法正确（见下）

## 地址选择（移动端/模拟器）
- 本机浏览器：`http://127.0.0.1:8080`
- Android 模拟器（AVD）：`http://10.0.2.2:8080`
- Genymotion：`http://10.0.3.2:8080`
- 真机同一 Wi‑Fi：`http://<电脑IPv4>:8080`（`ipconfig` 查看 `IPv4 地址`）
- USB 直连真机（可选）：`adb reverse tcp:8080 tcp:8080` 后用 `http://127.0.0.1:8080`

## 注册与登录
- 注册：
  - `POST /auth/register`
  - 请求头：`Content-Type: application/json`
  - 请求体：`{"username":"<账号>","password":"<密码>"}`
  - 响应成功：`{"token":"<JWT>","ttlSec":<秒>,"expiresAt":<毫秒>}`
  - 响应失败示例：`{"code":"CONFLICT","message":"username_exists"}`
- 登录：
  - `POST /auth/login`
  - 请求体同上；失败示例：`{"code":"UNAUTHORIZED","message":"invalid_credentials"}`
- 免登录：前端持久化 `token` 与过期时间，在未过期时自动登录

## 访问受保护接口
- 除 `/auth/*` 与 `/health` 外，所有接口需要 `Authorization: Bearer <token>`
- 常见错误：
  - `401 UNAUTHORIZED`：缺失或无效令牌
  - `VALIDATION_ERROR`：请求参数不合法

## 常见问题
- 连接失败（移动端）：
  - 地址未以 `http://` 开头或 IP/端口格式错误
  - 与电脑不在同一局域网或防火墙未放行
- 注册失败：
  - 数据库未准备，检查 `DB_URL/DB_USER/DB_PASS`
  - 用户名已存在返回 `CONFLICT`
- 构建失败：
  - Java 版本不符，需 Java 21

## 版本与变更
- 切换至账号密码登录/注册，返回 `token/ttlSec/expiresAt`
- 统一错误结构，新增 `/health`
- 支持 `APP_JWT_SECRET` 与 `APP_TOKEN_TTL_SEC`

